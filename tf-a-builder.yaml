- scm:
    name: tf-a-ci-scripts
    scm:
        - git:
            url: https://git.trustedfirmware.org/ci/tf-a-ci-scripts.git
            refspec: +refs/heads/master:refs/remotes/origin/master
            name: origin
            branches:
                - refs/heads/master
            basedir: tf-a-ci-scripts
            skip-tag: true
            shallow-clone: true
            wipe-workspace: false
- scm:
    name: trusted-firmware-a
    scm:
        - git:
            url: https://review.trustedfirmware.org/${TF_GERRIT_PROJECT}
            refspec: ${TF_GERRIT_REFSPEC}
            name: origin
            branches:
                - ${TF_GERRIT_BRANCH}
            basedir: trusted-firmware-a
            skip-tag: true
            shallow-clone: false
            wipe-workspace: false
- scm:
    name: tf-a-tests
    scm:
        - git:
            url: https://git.trustedfirmware.org/${TFTF_GERRIT_PROJECT}
            refspec: ${TFTF_GERRIT_REFSPEC}
            name: origin
            branches:
                - ${TFTF_GERRIT_BRANCH}
            basedir: tf-a-tests
            skip-tag: true
            shallow-clone: false
            wipe-workspace: false
- job:
    name: tf-a-builder
    node: docker-amd64-tf-a-bionic
    project-type: freestyle
    concurrent: true
    disabled: false
    defaults: global
    Description: |
      Trusted Firmware A (TF-A) builder
    properties:
        - build-discarder:
            days-to-keep: 180
            num-to-keep: 3000
        - authorization:
            !include: authorization.yaml.inc
    parameters:
        - string:
            name: import_cc
        - string:
            name: TEST_DESC
        - string:
            name: TF_GERRIT_PROJECT
            default: 'TF-A/trusted-firmware-a'
        - string:
            name: TF_GERRIT_BRANCH
            default: 'refs/heads/master'
        - string:
            name: TF_GERRIT_REFSPEC
            default: '+refs/heads/master:refs/remotes/origin/master'
        - string:
            name: TFTF_GERRIT_PROJECT
            default: 'TF-A/tf-a-tests'
        - string:
            name: TFTF_GERRIT_BRANCH
            default: 'refs/heads/master'
        - string:
            name: TFTF_GERRIT_REFSPEC
            default: '+refs/heads/master:refs/remotes/origin/master'
        - string:
            name: DOCKER_REGISTRY
            default: '987685672616.dkr.ecr.us-east-1.amazonaws.com'
        - string:
            name: ARMLMD_LICENSE_FILE
            default: '27000@ci.trustedfirmware.org'
        - string:
            name: JUNO_ROOTFS_URL
            default: 'http://releases.linaro.org/openembedded/aarch64/17.01/linaro-image-minimal-genericarmv8-20170127-888.rootfs.tar.gz'
        - string:
            name: MBEDTLS_URL
            default: 'https://github.com/ARMmbed/mbedtls/archive/mbedtls-2.25.0.tar.gz'
        - string:
            name: GERRIT_PATCHSET_NUMBER
            default: ''
        - string:
            name: GERRIT_CHANGE_NUMBER
            default: ''
        - string:
            name: GERRIT_HOST
            default: 'review.trustedfirmware.org'
        - string:
            name: QA_SERVER_TEAM
            default: 'tf'
        - string:
            name: QA_SERVER_PROJECT
            default: 'tf-a'
        - string:
            name: QA_SERVER
            default: 'https://qa-reports.linaro.org'
        - bool:
            name: ENABLE_STATIC_CHECK
            default: false
    scm:
        - tf-a-ci-scripts
        - trusted-firmware-a
        - tf-a-tests
    wrappers:
        - timestamps
        - credentials-binding:
            - text:
                credential-id: QA_REPORTS_TOKEN
                variable: QA_REPORTS_TOKEN
        - credentials-binding:
            - text:
                credential-id: LAVA_USER_TF
                variable: LAVA_USER
        - credentials-binding:
            - text:
                credential-id: LAVA_TOKEN_TF
                variable: LAVA_TOKEN
    builders:
        - shell:
            !include-raw: tf-a-builder/builders.sh
        - conditional-step:
            condition-kind: file-exists
            on-evaluation-failure: dont-run
            condition-filename: artefacts/debug/job.yaml
            condition-basedir: workspace
            steps:
            - shell:  |
                #!/bin/bash
                set -e
                DEVICE_TYPE=fvp
                CUSTOM_YAML_URL=${BUILD_URL}/artifact/artefacts/debug/job.yaml
                DEVICE_TYPE=$(awk -F': ' '/device_type/ {print $2}' ${WORKSPACE}/artefacts/debug/job.yaml)
                cat << EOF > ${WORKSPACE}/post-build-lava.param
                DEVICE_TYPE=${DEVICE_TYPE}
                LAVA_SERVER=tf.validation.linaro.org
                EOF
    publishers:
        - archive:
            artifacts: 'artefacts/**'
            latest-only: false
            allow-empty: true
        - conditional-publisher:
          - condition-kind: file-exists
            on-evaluation-failure: dont-run
            condition-filename: artefacts/debug/job.yaml
            condition-basedir: workspace
            action:
                - postbuildscript:
                    builders:
                        - role: SLAVE
                          build-on:
                              - SUCCESS
                          build-steps:
                            - inject:
                                properties-file: ${WORKSPACE}/post-build-lava.param
                            - shell:
                                !include-raw: tf-a-builder/test.sh
        - conditional-publisher:
          - condition-kind: file-exists
            on-evaluation-failure: dont-run
            condition-filename: lava.log
            condition-basedir: workspace
            action:
                - archive:
                    artifacts: lava.log
                    latest-only: false
                    allow-empty: true
        - groovy-postbuild:
            script:
                !include-raw:
                  - tf-a-builder/test.groovy
