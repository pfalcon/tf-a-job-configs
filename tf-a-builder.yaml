- scm:
    name: tf-a-ci-scripts
    scm:
        - git:
            url: https://git.trustedfirmware.org/ci/tf-a-ci-scripts.git
            refspec: +refs/heads/master:refs/remotes/origin/master
            name: origin
            branches:
                - refs/heads/master
            basedir: tf-a-ci-scripts
            skip-tag: true
            shallow-clone: true
            wipe-workspace: false
- scm:
    name: trusted-firmware-a
    scm:
        - git:
            url: https://review.trustedfirmware.org/${GERRIT_PROJECT}
            refspec: ${GERRIT_REFSPEC}
            name: origin
            branches:
                - ${GERRIT_BRANCH}
            basedir: trusted-firmware-a
            skip-tag: true
            shallow-clone: true
            wipe-workspace: false
- scm:
    name: tf-a-tests
    scm:
        - git:
            url: https://git.trustedfirmware.org/TF-A/tf-a-tests.git
            refspec: +refs/heads/master:refs/remotes/origin/master
            name: origin
            branches:
                - refs/heads/master
            basedir: tf-a-tests
            skip-tag: true
            shallow-clone: true
            wipe-workspace: false
- job:
    name: tf-a-builder
    project-type: freestyle
    defaults: global
    properties:
        - build-discarder:
            days-to-keep: 90
            num-to-keep: 90
    parameters:
        - string:
            name: test_groups
            default: 'tf-l1-build-juno/juno-default:nil'
        - string:
            name: GERRIT_PROJECT
            default: 'TF-A/trusted-firmware-a'
        - string:
            name: GERRIT_BRANCH
            default: 'master'
        - string:
            name: GERRIT_REFSPEC
            default: 'refs/heads/master'
    disabled: false
    node: docker-amd64-xenial
    display-name: 'Trusted Firmware A (TF-A) builder'
    scm:
        - tf-a-ci-scripts
        - trusted-firmware-a
        - tf-a-tests
    wrappers:
        - timestamps
    builders:
        - shell:
            !include-raw: tf-a-builder/builders.sh
        - shell:  |
            #!/bin/bash

            set -e

            rm -rf configs
            git clone --depth 1 https://git.trustedfirmware.org/ci/tf-a-job-configs.git configs

            sed -e "s|\${GERRIT_PROJECT}|${GERRIT_PROJECT}|" \
                -e "s|\${GERRIT_BRANCH}|${GERRIT_BRANCH}|" \
                -e "s|\${GERRIT_REFSPEC}|${GERRIT_REFSPEC}|" \
                -e "s|\${test_groups}|${test_groups}|" \
                -e "s|\${BUILD_URL}|${BUILD_URL}|" \
                < configs/tf-a-builder/lava-job-definitions/juno/template.yaml \
                > custom_lava_job_definition.yaml

            cat << EOF > ${WORKSPACE}/post_build_lava_parameters
            DEVICE_TYPE=juno
            CUSTOM_YAML_URL=${JOB_URL}/ws/custom_lava_job_definition.yaml
            LAVA_SERVER=tf.validation.linaro.org/RPC2/
            EOF
        - trigger-builds:
            - project: 'post-build-lava'
              property-file: post_build_lava_parameters
              block: true
    publishers:
        - archive:
            artifacts: 'artefacts/**'
            latest-only: false
